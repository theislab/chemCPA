# Config for hyperparameter-tuning CPA on SciPlex 3 with pretrained (and frozen) HierVAE drug embeddings.

seml:
  executable: compert/seml_sweep_icb.py
  name: cpa_graphs_sciplex3
  output_dir: sweeps/logs
  conda_environment: chemical_CPA
  project_root_dir: ..

slurm:
  experiments_per_job: 1
  max_jobs_per_batch: 4
  sbatch_options_template: GPU
  sbatch_options:
    gres: gpu:1       # num GPUs
    mem: 32G          # memory
    cpus-per-task: 6  # num cores
    time: 0-01:01     # max time, D-HH:MM

###### BEGIN PARAMETER CONFIGURATION ######

fixed:
  training.checkpoint_freq: 50 # checkpoint frequency to save intermediate results
  training.num_epochs: 100 # maximum epochs for training
  training.max_minutes: 300 # maximum computation time
  training.ignore_evaluation: False
  training.save_checkpoints: True
  training.save_dir: sweeps/checkpoints
  
  model.additional_params.seed: 0 # random seed
  model.additional_params.loss_ae: gauss # loss (currently only gaussian loss is supported)
  model.additional_params.patience: 20 # patience for early stopping
  model.additional_params.decoder_activation: linear # last layer of the decoder
  model.additional_params.doser_type: sigm # non-linearity for doser function
 
  dataset.dataset_type: trapnell
  dataset.data_params.dataset_path: datasets/trapnell_cpa.h5ad # full path to the anndata dataset
  dataset.data_params.perturbation_key: condition
  dataset.data_params.dose_key: dose
  dataset.data_params.covariate_keys: cell_type # necessary field for cell types. Fill it with a dummy variable if no celltypes present.
  dataset.data_params.smiles_key: SMILES
  dataset.data_params.split_key: split # necessary field for train, test, ood splits. 
  
grid:
  dataset.data_params.mol_featurizer: # determines the initial node & edge features that are input into the GNN
    type: choice 
    options: 
      - canonical # this featurizes each node and edge using a collection of features generated by RDKit
      # - AttentiveFP
      # - Pretrain

gnn_model: # configures the GNN used in end-to-end training of the embedding (not used anymore)
  fixed:
    model.gnn_model.hparams.n_layers: 2
    model.gnn_model.GCN.hparams.n_layers: 3
  grid:
    model.gnn_model.model_type:
      type: choice
      options:
        # - AttentiveFP
        # - GAT
        # - GCN
        # - MPNN
        # - weave
        - null


random:
  samples: 1
  seed: 42
  model.hparams.dropout:
    type: uniform
    min: 0.0
    max: 0.5
  model.hparams.dim: 
    type: choice 
    options: 
      - 128
      - 256 
      - 512
  model.hparams.dosers_width: 
    type: choice 
    options: 
      - 32
      - 64 
      - 128
  model.hparams.dosers_depth: 
    type: choice 
    options: 
      - 1
      - 2 
      - 3
  model.hparams.dosers_lr: 
    type: loguniform 
    min: 1e-4
    max: 1e-2
  model.hparams.dosers_wd: 
    type: loguniform 
    min: 1e-8
    max: 1e-5
  model.hparams.autoencoder_width: 
    type: choice 
    options: 
      - 256
      - 512
      - 1024
  model.hparams.autoencoder_depth: 
    type: choice 
    options: 
      - 3
      - 4 
      - 5
  model.hparams.autoencoder_lr: 
    type: loguniform 
    min: 1e-4
    max: 1e-2
  model.hparams.autoencoder_wd: 
    type: loguniform 
    min: 1e-8
    max: 1e-5
  model.hparams.adversary_width: 
    type: choice 
    options: 
      - 64
      - 128
      - 256
  model.hparams.adversary_depth: 
    type: choice 
    options: 
      - 2
      - 3 
      - 4
  model.hparams.adversary_lr: 
    type: loguniform 
    min: 1e-5
    max: 1e-3
  model.hparams.adversary_wd: 
    type: loguniform 
    min: 1e-6
    max: 1e-3
  model.hparams.adversary_steps: 
    type: choice 
    options: 
      - 1
      - 2 
      - 3
      - 4
      - 5
  model.hparams.reg_adversary: 
    type: loguniform
    min: 1e-2 
    max: 1e2
  model.hparams.penalty_adversary: 
    type: loguniform
    min: 1e-2
    max: 1e1
  model.hparams.batch_size: 
    type: choice 
    options: 
      - 64
      - 128 
      - 256 
      - 512
  model.hparams.step_size_lr: 
    type: choice 
    options: 
      - 15
      - 25
      - 45
